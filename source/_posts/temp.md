# P1315 [NOIP2011 提高组] 观光公交的 $n\log n\log k$ 做法

$k$ 终于成了 $\log$ 的一部分

![picture 0](/img/2023-08-22-09-38-50-image.png)  


假设读者已经都会了费用流的做法，因为是费用流，所以关于流量是凸的，我们考虑WQS二分加增量模拟费用流完成：

那么如图，加一个与S相连的点时要保证红边的方向，于是发现没有可行的负环/增广路，增加蓝色的点 $v$ 的时候增广路的形式是 $S\to u\to v\to T$ (浅蓝)，负环是 $T\to u\to v\to T$ (浅紫)，只有这两种决策，于是问题解决，开两个堆维护与 $S$ 相连，且 $S$ 到它的边上还能流的点和与 $T$ 相连，且它到 $T$ 的边有流量的点，用线段树维护中间的边的流量，用前缀和维护代价和，每次取出堆顶，计算两种决策的流量和代价，然后更新流量和答案。因为要控制流量，找增广路的时候要给代价额外加上二分的常数 $C$。

这里很好的性质就是由于我们的决策，一条非汇边满了之后不可能再退流，一条汇边在它之后空了之后不可能在有流量，所以只要每次取出堆顶暴力check，不满足直接弹就是对的。又因为处理每个负环和增广路的时候，我们至少会让一条边的流满，所以模拟费用流的复杂度是 $n\log n$ 的，最后上一个WQS二分，复杂度成了 $n\log n\log k$，现在可以出 $k\le 10^9$ 了！